---
title: "Computational Musicology Portfolio"
author: "Jeev Prayaga"
date: "Block 4"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    css: styles.scss
    theme: bootstrap
---

```{r setup, include=FALSE}
library(tidyverse)
library(flexdashboard)
library(spotifyr)
library(ggthemes)
library(plotly)
library(compmus)
library(ggpubr)


corpus <- get_playlist_audio_features("", "14Bfxipb26yzTFoxmDfjeg?si=ff7f24e465794647")
```


### How do chroma and timbre change during a song?

```{r}
#  (from "https://r-graphics.org/recipe-axes-time-rel")
timeHMS_formatter <- function(x) {
  h <- floor(x / 3600)
  m <- floor((x / 60) %% 60)
  s <- round(x %% 60)                       # Round to nearest second
  lab <- sprintf("%02d:%02d:%02d", h, m, s) # Format the strings as HH:MM:SS
  lab <- sub("^00:", "", lab)               # Remove leading 00: if present
  lab <- sub("^0", "", lab)                 # Remove leading 0 if present
  return(lab)
}

lom <-
  get_tidy_audio_analysis("3IgIofvAq4XuMgIiSTZZQs") %>% # Change URI.
  compmus_align(sections, segments) %>%                     # Change `bars`
  select(sections) %>%                                      #   in all three
  unnest(sections) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
          compmus_summarise, pitches,
          method = "mean", norm = "manhattan"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
          compmus_summarise, timbre,
          method = "mean", norm = "manhattan"              # Change summary & norm.
      ),
  )

lom_chroma <- lom %>% compmus_self_similarity(pitches, "manhattan")
lom_timbre <- lom %>% compmus_self_similarity(timbre, "manhattan")


chroma_plot <- ggplot(lom_chroma,
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title="Chroma") +
  scale_x_continuous(
    name = "Time",
    breaks = seq(0, 1000, by = 15),
    labels = timeHMS_formatter
  ) +
  scale_y_continuous(
    name = "Time",
    breaks = seq(0, 1000, by = 15),
    labels = timeHMS_formatter
  )

timbre_plot <- ggplot(lom_timbre,
  aes(
    x = xstart + xduration / 2,
    width = xduration,
    y = ystart + yduration / 2,
    height = yduration,
    fill = d
  )
) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title="Timbre") +
  scale_x_continuous(
    name = "Time",
    breaks = seq(0, 1000, by = 30),
    labels = timeHMS_formatter
  ) +
  scale_y_continuous(
    name = "Time",
    breaks = seq(0, 1000, by = 30),
    labels = timeHMS_formatter
  )


bir <-
  get_tidy_audio_analysis("4Cegr1EzzvG8D77lUIsfSK") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
          compmus_summarise, pitches,
          method = "mean", norm = "manhattan"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
          compmus_summarise, timbre,
          method = "mean", norm = "manhattan"              # Change summary & norm.
      ),
  )

bir_timbre <- bir %>% compmus_gather_timbre()

cepstro_plot <- ggplot(bir_timbre,
  aes(
    x = start + duration / 2,
    width = duration,
    y = basis,
    fill = value
  )
) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title="\"Bir Olasılık\" Cepstrogram") +
  scale_fill_viridis_c() +                              
  theme_classic() +
  scale_x_continuous(
    name = "Time",
    breaks = seq(0, 1000, by = 10),
    labels = timeHMS_formatter
  )

figure <- ggarrange(
  cepstro_plot, 
  ggarrange(chroma_plot, timbre_plot, ncol = 2),
  nrow = 2,
  labels = NULL
)
figure

```

***
The top plot is a cepstrogram that visualises the timbre of "Bir Olasılık," an instrumental track by Erkin Koray. Since drums are the only instrument in this track, I thought it would be interesting to analyze how timbre changes thruoghout the song. As the plot shows, timbre stays relatively consistent in the C2, C3, and C6 rows, although there are parts in which certain timbres fade into the background or suddenly appear. One notable moment is around the 1:25 minute mark, where there is a bright yellow (high magnitude) section in the C2 row. This correspondes with a drum break that heavily features the cymbal, meaning the C2 timbre might correspond with cymbals or other drum components with similar timbre.

The bottom two plots represent chroma-based and timbre-based self-similarity matrices for the song "Lies of Mercy" by the Durutti Column. This song features a repetitive guitar riff that weaves in and out of the song. This track also has several distinct "sections" that correspond with chord changes. The timbre plot shows large chunks of similarity, since most of the song uses the same guitar and vocals. However, we can clearly see changes in the chroma plot for each of the sections. For example, the 40-second mark represents the change from the first verse to the chorus, and we see this change represented on the plot. There are also chunks of similarity (like the motif from 0:55 to 1:15, which repeats again at 2:05).

### Introduction

A few years ago, I decided to create a new Spotify playlist each month in order to capture my favorite music at various points in time. To keep each playlist consistent, I gave myself the following three conditions:
1. the playlist would contain exactly 11 songs
2. no two songs in the playlist could have the same artist
3. every song in the playlist had to be a song I had listened to during the given calendar month

Between March 2018 and January 2022, I ended up creating 41 monthly playlists, which I have now combined into a single 451-song playlist.

**I think this playlist could serve as a corpus for my portfolio project because it represents the diversity of my music preferences, reflects month-by-month changes in how I listen to music, and reveals long-term trends for how my taste in music may have changed over a period of four years.**

I think the variable of time can be used to create and compare groups of songs. For example, I can compare the valence of songs I added before the COVID-19 pandemic to those I added during lockdown. I can also investigate how different seasons might affect my listening history -- do I listen to more upbeat music in warmer months, or during the winter in an attempt to boost my mood? How has my appreciation for certain artists and genres changed month-by-month and year-by-year?

Since I almost exclusively listen to music on Spotify, I believe this corpus is highly representative of my personal listening habits. I also think the variation in songs will allow me to analyze certain tracks in greater detail. Songs like "2021" by A.G. Cook (a short, digitally-produced electronic track) will contrast greatly with "Obi Agye Me Dofo" by Vis à Vis (a 10-minute Afrobeat track recorded live in the 1970s). These songs fall on different sides of the spectrum in terms of length, genre, and "acousticness," making them good candidates for investigation.


### How are valence, energy, loudness, and acousticness related?

```{r}

font <- list(
  family = "Public Sans",
  size = 12,
  color = "white"
)
label <- list(
  bgcolor = "#232F34",
  bordercolor = "transparent",
  font = font
)

p <- ggplot(
  corpus,
  aes(
    x = energy,
    y = valence,
    alpha = loudness,
    size = acousticness,
    name = track.name,
    text = paste(
      "Track: ", track.name,
      "<br>Valence: ", valence,
      "<br>Energy: ", energy,
      "<br>Loudness: ", loudness,
      "<br>Acousticness: ", acousticness
    ))
  ) +
  geom_point(color = "#15a353") +
  scale_size(trans = "reverse") +
  labs(
    title = "Valence, energy, loudness, and acousticness by track",
    x = "Track energy",
    y = "Track valence",
    size = "Track acousticness",
    alpha = "Track loudness"
  ) +
  theme_few()


fig <- ggplotly(p, tooltip = "text") %>%
  style(hoverlabel = label) %>%
  layout(font = font)

fig

```

*** 

This scatterplot maps valence, energy, loudness, and acousticness for every track in the corpus. Using valence and energy on the x- and y-axis respectively, we can see an upward trend showing that higher energy tracks have a higher valence, meaning they are sound more positive to the listener. Using transparency as a fourth variable, we can see that higher energy/valence tracks are also louder, since the darkest points are in the top right quadrant of the plot. Finally, since size represents acousticness on this plot, it is clear that highly acoustic tracks have low valence and energy, since there are very few large points in the top right quadrant.

### How closely do cover songs in different languages align?

```{r}

hier_encore_track <- "4ciRwt5dGHKKm8Et8r1xJ0"
yesterday_track <- "7nSjdcQueimUqsDsBq7orE"

hier_encore <-
  get_tidy_audio_analysis(hier_encore_track) %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

yesterday <-
  get_tidy_audio_analysis(yesterday_track) %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)


compmus_long_distance(
  yesterday %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  hier_encore %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(title = "Dynamic Time Warping", x = "Yesterday When I Was Young", y = "Hier Encore") +
  scale_fill_viridis_c(guide = NULL)

```

*** 

This plot represents a dynamic time warping between two versions of the famous French chanson "Hier encore." The original version was released in 1964 by Charles Azvanour. Five years later, the American country singer Roy Clark recorded an English version of the song, titled "Yesterday When I Was Young." Since these songs have different lyrics (sung in different languages) and employ different instrumentation, I wanted to investigate how musically similar the two songs really are. This plot shows the chroma features of each song, and similarity is shown by the several faint diagonal lines throughout the song. Although it is clear that the songs are not exactly the same (which would be shown by much clearer diagonal lines that have a slope of 1), we can see some similarities where chords are most likely aligning. Conversely, the parts of the plot where the lines become fragmented or broken probably represent parts of the songs where the chords does not align.

